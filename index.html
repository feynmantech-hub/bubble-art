<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D Bubble V4</title>
    <style>
        body { background-color: #000; color: white; font-family: sans-serif; margin: 0; overflow: hidden; }
        #log-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 50%;
            background: rgba(20, 20, 20, 0.9); overflow-y: scroll;
            padding: 10px; font-family: monospace; font-size: 14px; border-bottom: 2px solid #555;
            z-index: 999;
        }
        .log-line { margin: 5px 0; border-bottom: 1px solid #333; padding-bottom: 2px; }
        .success { color: #0f0; }
        .error { color: #f55; font-weight: bold; }
        .info { color: #ff0; }
        
        #btn-area {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50%;
            display: flex; justify-content: center; align-items: center;
            z-index: 100;
        }
        button {
            padding: 20px 40px; font-size: 20px; border-radius: 10px;
            background: #666; color: #ccc; border: none; cursor: not-allowed;
        }
        button.ready {
            background: #007bff; color: white; cursor: pointer; box-shadow: 0 0 15px #007bff;
        }
        
        #version-tag {
            position: absolute; top: 10px; right: 10px; color: #555; font-size: 12px; z-index: 1000;
        }
    </style>
</head>
<body>

    <div id="version-tag">ç‰ˆæœ¬: V4.0 (ç¶²è·¯è¨ºæ–·)</div>

    <div id="log-container">
        <div class="log-line info">1. ç¶²é æ¶æ§‹å·²è¼‰å…¥</div>
    </div>

    <div id="btn-area">
        <button id="start-btn" disabled>æ­£åœ¨ä¸‹è¼‰ç¨‹å¼åº«...</button>
    </div>

    <video id="camera-feed" playsinline webkit-playsinline muted style="position:absolute; bottom:0; right:0; width:1px; opacity:0;"></video>

    <script>
        const logger = document.getElementById('log-container');
        const btn = document.getElementById('start-btn');
        let libCount = 0;
        const totalLibs = 3;

        function log(msg, type = '') {
            const div = document.createElement('div');
            div.className = 'log-line ' + type;
            div.innerText = `[${new Date().toLocaleTimeString()}] ${msg}`;
            logger.appendChild(div);
            console.log(msg);
        }

        function checkLibs() {
            libCount++;
            log(`ç¨‹å¼åº«é€²åº¦: ${libCount} / ${totalLibs}`, 'info');
            if (libCount === totalLibs) {
                log('âœ… æ‰€æœ‰ç¨‹å¼åº«ä¸‹è¼‰å®Œæˆï¼', 'success');
                btn.innerText = "é»æ“Šé–‹å§‹";
                btn.disabled = false;
                btn.classList.add('ready');
                
                // ç¶å®šé»æ“Šäº‹ä»¶
                btn.onclick = startCamera;
            }
        }

        async function startCamera() {
            btn.style.display = 'none';
            log('æ­£åœ¨è«‹æ±‚ç›¸æ©Ÿæ¬Šé™...', 'info');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } });
                document.getElementById('camera-feed').srcObject = stream;
                document.getElementById('camera-feed').play();
                log('âœ… ç›¸æ©Ÿå·²é–‹å•Ÿï¼é–‹å§‹è¼‰å…¥ AI...', 'success');
                initApp(); // å•Ÿå‹•ä¸»ç¨‹å¼
            } catch (err) {
                log('âŒ ç›¸æ©Ÿé–‹å•Ÿå¤±æ•—: ' + err.message, 'error');
                alert('ç›¸æ©Ÿå¤±æ•—: ' + err.message);
                btn.style.display = 'block';
            }
        }

        // è¨­ç½®é€¾æ™‚è­¦å‘Š (å¦‚æœ 8 ç§’é‚„æ²’è¼‰å…¥å®Œ)
        setTimeout(() => {
            if (libCount < totalLibs) {
                log('âš ï¸ è­¦å‘Šï¼šä¸‹è¼‰é€¾æ™‚ã€‚æ‚¨çš„ç¶²è·¯å¯èƒ½å°é–äº† CDNï¼Œæˆ–ç¶²é€Ÿéæ…¢ã€‚', 'error');
                log('è«‹å˜—è©¦åˆ‡æ› Wi-Fi / 4G ç¶²è·¯ã€‚', 'error');
            }
        }, 8000);

    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js" 
            onload="log('Three.js ä¸‹è¼‰æˆåŠŸ', 'success'); checkLibs();" 
            onerror="log('âŒ Three.js ä¸‹è¼‰å¤±æ•—', 'error');"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" 
            onload="log('Camera Utils ä¸‹è¼‰æˆåŠŸ', 'success'); checkLibs();" 
            onerror="log('âŒ Camera Utils ä¸‹è¼‰å¤±æ•—', 'error');"></script>

    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" 
            onload="log('Face Mesh ä¸‹è¼‰æˆåŠŸ', 'success'); checkLibs();" 
            onerror="log('âŒ Face Mesh ä¸‹è¼‰å¤±æ•—', 'error');"></script>

    <script>
        function initApp() {
            // ç°¡åŒ–çš„ 3D èˆ‡ AI å•Ÿå‹•é‚è¼¯
            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x333333);
            const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.z = 5;
            const renderer = new THREE.WebGLRenderer();
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            renderer.domElement.style.zIndex = -1; // æ”¾åœ¨æœ€ä¸‹å±¤

            // æ¸¬è©¦ç”¨ç«‹æ–¹é«” (è­‰æ˜ 3D æœ‰è·‘)
            const cube = new THREE.Mesh(new THREE.BoxGeometry(), new THREE.MeshNormalMaterial());
            scene.add(cube);

            // AI å•Ÿå‹•
            const faceMesh = new FaceMesh({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`});
            faceMesh.setOptions({maxNumFaces: 1, minDetectionConfidence: 0.5});
            faceMesh.onResults(results => {
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;
                if (results.multiFaceLandmarks.length > 0) {
                    cube.scale.set(1.5, 1.5, 1.5); // åµæ¸¬åˆ°è‡‰å°±è®Šå¤§
                } else {
                    cube.scale.set(1, 1, 1);
                }
            });

            const video = document.getElementById('camera-feed');
            const cameraUtils = new Camera(video, {
                onFrame: async () => { await faceMesh.send({image: video}); },
                width: 640, height: 480
            });
            cameraUtils.start();
            
            function animate() {
                requestAnimationFrame(animate);
                renderer.render(scene, camera);
            }
            animate();
            log('ğŸš€ ç³»çµ±å®Œå…¨å•Ÿå‹•ï¼çœ‹åˆ°æ—‹è½‰æ–¹å¡Šäº†å—ï¼Ÿ', 'success');
            setTimeout(() => { logger.style.display = 'none'; }, 2000); // æˆåŠŸå¾Œéš±è—æ—¥èªŒ
        }
    </script>
</body>
</html>
