<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D 泡泡 (相容模式)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 100; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; pointer-events: none;
        }

        /* 超大按鈕，確保按得到 */
        #btn-start {
            pointer-events: auto;
            width: 200px; height: 80px;
            background: #00AAFF; color: white; border: 2px solid white;
            font-size: 24px; border-radius: 20px; font-weight: bold;
            box-shadow: 0 0 20px rgba(0,170,255,0.8);
            cursor: pointer;
        }
        #btn-start:active { background: #0088cc; transform: scale(0.95); }

        #debug-text {
            margin-top: 20px; color: yellow; background: rgba(0,0,0,0.5); 
            padding: 10px; border-radius: 5px; text-align: center;
            font-size: 14px; max-width: 90%; pointer-events: auto;
        }

        #camera-video {
            position: absolute; bottom: 0; right: 0; width: 1px; height: 1px; opacity: 0;
        }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="ui-layer">
        <button id="btn-start" onclick="startApp()">開始體驗</button>
        <div id="debug-text">系統初始化中...</div>
    </div>

    <video id="camera-video" playsinline webkit-playsinline muted></video>

    <script>
        // --- 除錯工具 ---
        const debugDiv = document.getElementById('debug-text');
        const btn = document.getElementById('btn-start');
        
        function log(msg) {
            debugDiv.innerHTML += "<br>" + msg;
            console.log(msg);
        }

        window.onerror = function(msg, url, line) {
            alert("程式發生錯誤:\n" + msg);
            log("錯誤: " + msg);
        };

        // --- 檢查庫是否載入 ---
        log("檢查程式庫...");
        if (typeof THREE === 'undefined') log("❌ Three.js 載入失敗");
        else log("✅ Three.js 載入成功");

        if (typeof FaceMesh === 'undefined') log("❌ FaceMesh 載入失敗 (可能需等待)");
        else log("✅ FaceMesh 載入成功");

        // --- 主程式邏輯 ---
        let scene, camera, renderer, bubbles = [];
        let windVector = new THREE.Vector3(0,0,0);
        let isBlowing = false;
        let time = 0;

        // 這是按鈕綁定的功能
        async function startApp() {
            // 1. 強制彈出視窗，測試按鈕是否活著
            alert("按鈕已點擊！即將請求相機...");
            
            btn.style.display = 'none';
            log("正在啟動相機...");

            const videoElement = document.getElementById('camera-video');

            try {
                // 2. 先嘗試「直接」開鏡頭，不透過 MediaPipe (排除庫的問題)
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 640, height: 480, facingMode: 'user' }, 
                    audio: false 
                });
                
                videoElement.srcObject = stream;
                await videoElement.play();
                log("✅ 相機硬體已啟動！");

                // 3. 初始化 3D 場景
                initThreeJS();

                // 4. 初始化 AI
                log("啟動 AI 模型...");
                const faceMesh = new FaceMesh({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }});
                
                faceMesh.setOptions({
                    maxNumFaces: 1, refineLandmarks: true, 
                    minDetectionConfidence: 0.5, minTrackingConfidence: 0.5
                });
                
                faceMesh.onResults(onResults);
                
                // 開始傳送影像給 AI
                async function sendFrame() {
                    await faceMesh.send({image: videoElement});
                    requestAnimationFrame(sendFrame);
                }
                sendFrame();
                log("系統運行中！請嘟嘴試試");
                debugDiv.style.display = 'none'; // 成功後隱藏文字

            } catch (err) {
                alert("無法開啟相機: " + err.message);
                log("錯誤: " + err.message);
                btn.style.display = 'block';
                btn.innerText = "重試";
            }
        }

        // --- 嘴型偵測 ---
        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const landmarks = results.multiFaceLandmarks[0];
                const topLip = landmarks[13]; 
                const bottomLip = landmarks[14];
                const leftCorner = landmarks[61];
                const rightCorner = landmarks[291];
                
                // 簡易寬高比計算
                const h = Math.abs(topLip.y - bottomLip.y);
                const w = Math.abs(leftCorner.x - rightCorner.x);
                const ratio = h / w;

                // 測試閥值 (這個值可能需要根據你的臉型微調)
                if (ratio > 0.4) isBlowing = true; 
                else isBlowing = false;
            }
        }

        // --- Three.js 設置 ---
        function initThreeJS() {
            scene = new THREE.Scene();
            
            // 簡單背景
            scene.background = new THREE.Color(0x87CEEB);

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 100);
            camera.position.z = 5;

            renderer = new THREE.WebGLRenderer({antialias:true});
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);
            
            // 把 Canvas 放到最後面，不要擋住按鈕
            renderer.domElement.style.position = 'absolute';
            renderer.domElement.style.top = '0';
            renderer.domElement.style.zIndex = '0';

            const light = new THREE.DirectionalLight(0xffffff, 1);
            light.position.set(0, 10, 10);
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x404040));

            animate();
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.02;
            
            // 簡單風場
            windVector.set(Math.sin(time)*0.02, 0.01, 0);

            // 如果嘟嘴，產生泡泡
            if (isBlowing && Math.random() > 0.8) {
                createBubble();
            }

            // 更新泡泡
            for (let i = bubbles.length - 1; i >= 0; i--) {
                let b = bubbles[i];
                b.position.add(windVector);
                b.position.y += 0.02; // 浮力
                b.material.opacity -= 0.005;
                
                if (b.position.y > 5 || b.material.opacity <= 0) {
                    scene.remove(b);
                    bubbles.splice(i, 1);
                }
            }
            renderer.render(scene, camera);
        }

        function createBubble() {
            const geo = new THREE.SphereGeometry(0.3 + Math.random()*0.2, 32, 32);
            const mat = new THREE.MeshPhongMaterial({
                color: 0xffffff, transparent: true, opacity: 0.8, shininess: 100
            });
            const mesh = new THREE.Mesh(geo, mat);
            mesh.position.set((Math.random()-0.5), -2, 0);
            bubbles.push(mesh);
            scene.add(mesh);
        }

        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });
    </script>
</body>
</html>
