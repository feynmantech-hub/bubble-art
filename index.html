<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D 吹泡泡 (除錯版)</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #222; font-family: sans-serif; }
        
        /* 除錯控制台 (顯示錯誤訊息用) */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; height: 150px;
            background: rgba(0, 0, 0, 0.8); color: #0f0; font-family: monospace;
            font-size: 12px; padding: 10px; box-sizing: border-box;
            overflow-y: auto; z-index: 9999; pointer-events: none;
            white-space: pre-wrap; border-bottom: 1px solid #555;
        }

        #ui-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 100;
        }

        #start-btn {
            pointer-events: auto;
            background: #007bff; border: none;
            color: white; padding: 20px 50px; font-size: 1.5rem;
            border-radius: 10px; cursor: pointer; margin-top: 150px; /* 避開除錯視窗 */
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        #start-btn:disabled { background: #555; cursor: wait; }

        #camera-feed {
            position: absolute; bottom: 10px; right: 10px; width: 120px; height: 90px;
            transform: scaleX(-1); opacity: 0.8; z-index: 10; background: #333;
        }
    </style>
</head>
<body>

    <div id="debug-console">等待載入...</div>

    <div id="ui-container">
        <button id="start-btn" disabled>載入中...</button>
    </div>
    
    <video id="camera-feed" playsinline webkit-playsinline muted></video>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/",
                "@mediapipe/face_mesh": "https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/index.js",
                "@mediapipe/camera_utils": "https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { FaceMesh } from '@mediapipe/face_mesh';
        import { Camera } from '@mediapipe/camera_utils';

        const debugEl = document.getElementById('debug-console');
        const startBtn = document.getElementById('start-btn');
        const videoElement = document.getElementById('camera-feed');

        function log(msg, isError = false) {
            const time = new Date().toLocaleTimeString();
            const line = `[${time}] ${msg}\n`;
            debugEl.innerText = line + debugEl.innerText; // 新訊息在最上面
            if (isError) debugEl.style.color = '#ff4444';
            console.log(msg);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`系統錯誤: ${message}`, true);
        };

        log("程式開始初始化...");

        // --- 1. Three.js 場景 ---
        const scene = new THREE.Scene();
        const camera3d = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera3d.position.z = 5;
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        // 燈光與泡泡
        scene.add(new THREE.AmbientLight(0xffffff, 1.5));
        const dirLight = new THREE.DirectionalLight(0xffffff, 3);
        dirLight.position.set(5, 10, 7);
        scene.add(dirLight);

        const bubbles = [];
        const bubbleGeo = new THREE.SphereGeometry(1, 32, 32);
        const bubbleMat = new THREE.MeshPhysicalMaterial({
            color: 0xffffff, transmission: 1, thickness: 0.1, roughness: 0, iridescence: 1, transparent: true
        });

        class Bubble {
            constructor() {
                this.mesh = new THREE.Mesh(bubbleGeo, bubbleMat);
                this.mesh.scale.setScalar(0.2 + Math.random() * 0.3);
                this.mesh.position.set((Math.random()-0.5), -2, 0);
                this.life = 1.0;
                scene.add(this.mesh);
            }
            update() {
                this.mesh.position.y += 0.03;
                this.life -= 0.005;
                if(this.life < 0) { scene.remove(this.mesh); return false; }
                return true;
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if (Math.random() > 0.95 && window.isBlowing) bubbles.push(new Bubble());
            for (let i = bubbles.length - 1; i >= 0; i--) {
                if (!bubbles[i].update()) bubbles.splice(i, 1);
            }
            renderer.render(scene, camera3d);
        }
        animate();
        log("3D 場景建立完成");

        // --- 2. AI 模型設定 ---
        let faceMesh;
        let cameraUtils;
        window.isBlowing = false; // 全域變數

        async function initAI() {
            try {
                log("正在下載 FaceMesh 模型 (請稍候)...");
                
                faceMesh = new FaceMesh({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }});

                faceMesh.setOptions({
                    maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5
                });

                faceMesh.onResults((results) => {
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        const landmarks = results.multiFaceLandmarks[0];
                        // 簡單嘴型判斷
                        const h = Math.hypot(landmarks[13].y - landmarks[14].y, landmarks[13].x - landmarks[14].x);
                        const w = Math.hypot(landmarks[61].y - landmarks[291].y, landmarks[61].x - landmarks[291].x);
                        if ((h / w) > 0.5) window.isBlowing = true;
                        else window.isBlowing = false;
                    }
                });
                
                // 這裡初始化成功
                log("FaceMesh 模型準備就緒！");
                startBtn.disabled = false;
                startBtn.innerText = "點擊開始 (啟動鏡頭)";
                
            } catch (err) {
                log(`AI 模型載入失敗: ${err.message}`, true);
            }
        }
        
        // 立即執行 AI 初始化
        initAI();

        // --- 3. 按鈕點擊 ---
        startBtn.addEventListener('click', async () => {
            log("按鈕被點擊，正在請求鏡頭權限...");
            startBtn.disabled = true;
            
            try {
                // 使用 MediaPipe 的 Camera Utils
                cameraUtils = new Camera(videoElement, {
                    onFrame: async () => {
                        await faceMesh.send({image: videoElement});
                    },
                    width: 640,
                    height: 480
                });

                await cameraUtils.start();
                log("鏡頭啟動成功！請嘟嘴吹氣");
                document.getElementById('ui-container').style.display = 'none'; // 隱藏按鈕
                
            } catch (err) {
                log(`鏡頭啟動失敗: ${err.message}`, true);
                log(`請檢查：\n1. 網址是否為 https\n2. 是否封鎖了相機`, true);
                alert("無法開啟鏡頭，請看上方錯誤訊息");
                startBtn.disabled = false;
            }
        });
    </script>
</body>
</html>
