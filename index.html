<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D æ³¡æ³¡ (V5.0 ç›¸æ©Ÿä¿®å¾©ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        html, body {
            margin: 0;
            overflow: hidden;
            width: 100%;
            height: 100%;
            background: linear-gradient(180deg, #2b1055 0%, #7597de 100%) !important;
            font-family: "Microsoft JhengHei", sans-serif;
            color: white;
        }

        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
        }

        /* é™¤éŒ¯æ—¥èªŒ */
        #error-log {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 120px;
            background: rgba(0, 0, 0, 0.6);
            color: #0f0;
            font-family: monospace;
            font-size: 11px;
            overflow-y: scroll;
            z-index: 9999;
            padding: 10px;
            pointer-events: none; 
            display: block;
        }

        /* å•Ÿå‹•ç•«é¢ */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            text-align: center;
        }

        button {
            padding: 15px 30px;
            font-size: 1.2rem;
            margin: 15px;
            border-radius: 50px;
            border: none;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
        }
        button:active { transform: scale(0.95); }
        #btn-camera { background: #fd79a8; color: white; box-shadow: 0 0 15px #fd79a8; }
        #btn-mouse { background: #0984e3; color: white; }

        #status-text {
            position: absolute;
            top: 20px;
            width: 100%;
            text-align: center;
            z-index: 10;
            font-size: 1.2rem;
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            pointer-events: none;
        }
        
        /* ã€é—œéµä¿®æ­£ã€‘ä¸èƒ½ç”¨ display: noneï¼Œå¦å‰‡ç›¸æ©Ÿæœƒåœæ­¢æ›´æ–° */
        /* æ”¹ç”¨é€æ˜åº¦0 + ç§»å‡ºç•«é¢å¤– */
        .input_video { 
            position: fixed;
            top: -10000px;
            left: -10000px;
            width: 640px; 
            height: 480px;
            visibility: hidden; /* ç¢ºä¿ä¸å¹²æ“¾ç•«é¢ï¼Œä½† DOM ä»å­˜åœ¨ */
        }
    </style>
</head>
<body>

    <div id="error-log">ç³»çµ±æ—¥èªŒ V5.0:<br></div>
    <div id="status-text">ç³»çµ±è¼‰å…¥ä¸­...</div>

    <div id="start-screen">
        <h1>ğŸ«§ 3D æ³¡æ³¡å¯¦é©—å®¤</h1>
        <p id="loading-hint">æ­£åœ¨ä¸‹è¼‰ AI æ¨¡å‹...</p>
        
        <div id="btn-container" style="display:none;">
            <button id="btn-camera">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿå¹æ°£</button>
            <button id="btn-mouse">ğŸ–±ï¸ æ»‘é¼ æ¨¡å¼ (æ¸¬è©¦ç”¨)</button>
        </div>
        <p style="font-size: 0.8rem; color:#aaa; margin-top:20px;">
            ä¿®å¾©ç›¸æ©Ÿé»‘å±å•é¡Œ
        </p>
    </div>

    <video class="input_video" playsinline webkit-playsinline muted autoplay></video>

    <script>
        const logBox = document.getElementById('error-log');
        function screenLog(msg, color='#0f0') {
            const div = document.createElement('div');
            div.innerText = `> ${msg}`;
            div.style.color = color;
            logBox.appendChild(div);
            logBox.scrollTop = logBox.scrollHeight;
            console.log(msg);
        }
        
        window.onerror = function(msg, source, line) {
            screenLog(`éŒ¯èª¤: ${msg} (Line: ${line})`, '#ff3333');
            return false;
        };

        window.onload = function() {
            if(!window.FaceMesh || !window.Camera) {
                screenLog("è­¦å‘Š: AI å‡½å¼åº«æœªå®Œå…¨è¼‰å…¥", 'yellow');
            } else {
                screenLog("AI æ ¸å¿ƒå·²å°±ç·’", '#00ffff');
                document.getElementById('loading-hint').style.display = 'none';
                document.getElementById('btn-container').style.display = 'block';
                document.getElementById('status-text').innerText = "è«‹é¸æ“‡æ¨¡å¼";
            }
        };
    </script>

    <script type="module">
        import * as THREE from 'https://esm.sh/three@0.160.0';
        import { OrbitControls } from 'https://esm.sh/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        screenLog("Three.js (ESM) è¼‰å…¥æˆåŠŸ");

        let scene, camera, renderer, controls;
        let bubbles = [];
        let isBlowing = false;
        let blowDirection = 0;
        let mode = 'none';
        const raycaster = new THREE.Raycaster();
        const mouse = new THREE.Vector2();
        let frameCount = 0; // ç”¨æ–¼è¨ˆç®—å¹€æ•¸

        // --- 3D åˆå§‹åŒ– ---
        function initThree() {
            try {
                screenLog("å•Ÿå‹• 3D å¼•æ“...");
                scene = new THREE.Scene();
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 0, 20);

                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                document.body.appendChild(renderer.domElement);

                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.minDistance = 5;
                controls.maxDistance = 50;

                scene.add(new THREE.AmbientLight(0xffffff, 0.6));
                const dirLight = new THREE.DirectionalLight(0xffffff, 1.5);
                dirLight.position.set(10, 20, 10);
                scene.add(dirLight);

                window.addEventListener('resize', () => {
                    camera.aspect = window.innerWidth / window.innerHeight;
                    camera.updateProjectionMatrix();
                    renderer.setSize(window.innerWidth, window.innerHeight);
                });

                window.addEventListener('pointerdown', (event) => {
                    mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
                    raycaster.setFromCamera(mouse, camera);
                    const hits = raycaster.intersectObjects(bubbles.map(b => b.mesh));
                    if (hits.length > 0) {
                        const target = hits[0].object;
                        scene.remove(target);
                        bubbles = bubbles.filter(b => b.mesh !== target);
                    }
                });

                window.addEventListener('pointermove', (e) => {
                    if (mode === 'mouse') {
                        if (e.buttons > 0) {
                            isBlowing = true;
                            blowDirection = (e.clientX / window.innerWidth - 0.5) * 8;
                            document.getElementById('status-text').innerText = "ğŸŒ¬ï¸ æ¨¡æ“¬å¹æ°£ä¸­...";
                        } else {
                            isBlowing = false;
                        }
                    }
                });

                animate();
                screenLog("3D å ´æ™¯é‹ä½œä¸­");
            } catch (e) {
                screenLog("3D åˆå§‹åŒ–å¤±æ•—: " + e.message, 'red');
            }
        }

        // --- æ³¡æ³¡ ---
        const geometry = new THREE.SphereGeometry(1, 64, 64);
        const material = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            transmission: 1,
            opacity: 1,
            roughness: 0,
            ior: 1.5,
            thickness: 0.1,
            iridescence: 1,
            iridescenceIOR: 1.3,
            clearcoat: 1
        });

        function createBubble() {
            const bubble = new THREE.Mesh(geometry, material.clone());
            bubble.position.set((Math.random()-0.5)*2, -8, 5);
            const s = 0.8 + Math.random();
            bubble.scale.set(s,s,s);
            scene.add(bubble);

            const speedX = blowDirection * 0.3 + (Math.random()-0.5)*0.2;
            bubbles.push({
                mesh: bubble,
                velocity: new THREE.Vector3(speedX, 0.1 + Math.random()*0.1, -0.1)
            });
        }

        function animate() {
            requestAnimationFrame(animate);
            if(controls) controls.update();
            if (isBlowing && Math.random() > 0.85) createBubble();

            for (let i = bubbles.length - 1; i >= 0; i--) {
                const b = bubbles[i];
                b.mesh.position.add(b.velocity);
                b.mesh.position.y += Math.sin(Date.now()*0.001 + b.mesh.id)*0.01;
                if (b.mesh.position.y > 30) {
                    scene.remove(b.mesh);
                    bubbles.splice(i, 1);
                }
            }
            if(renderer) renderer.render(scene, camera);
        }

        // --- ç›¸æ©Ÿæ§åˆ¶ ---
        document.getElementById('btn-mouse').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            mode = 'mouse';
            initThree();
            document.getElementById('status-text').innerText = "ğŸ‘† æŒ‰ä½æ»‘é¼ /è¢å¹•ä¾†å¹æ°£";
        });

        document.getElementById('btn-camera').addEventListener('click', async () => {
            try {
                document.getElementById('start-screen').style.display = 'none';
                document.getElementById('status-text').innerText = "ğŸ“¸ å•Ÿå‹•ç›¸æ©Ÿ (è«‹å…è¨±æ¬Šé™)...";
                mode = 'camera';
                initThree(); 

                const videoElement = document.querySelector('.input_video');
                
                if (!window.FaceMesh) throw new Error("FaceMesh åº«æœªè¼‰å…¥");
                
                const faceMesh = new window.FaceMesh({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                }});
                
                faceMesh.setOptions({
                    maxNumFaces: 1,
                    refineLandmarks: true,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                faceMesh.onResults((results) => {
                    // åªè¦é€™è£¡æœ‰è¢«åŸ·è¡Œï¼Œå°±ä»£è¡¨ç›¸æ©Ÿæ­£å¸¸å·¥ä½œ
                    if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                        const lm = results.multiFaceLandmarks[0];
                        const h = Math.hypot(lm[13].x - lm[14].x, lm[13].y - lm[14].y);
                        const w = Math.hypot(lm[61].x - lm[291].x, lm[61].y - lm[291].y);
                        const ratio = h / w;
                        const faceX = lm[1].x;
                        blowDirection = (0.5 - faceX) * 8; 

                        // é¡¯ç¤ºæª¢æ¸¬æ•¸æ“šï¼Œç¢ºèªæœ‰åœ¨è·‘
                        // document.getElementById('status-text').innerText = `R: ${ratio.toFixed(2)}`;

                        if (ratio > 0.5 && h > 0.01) {
                            isBlowing = true;
                            document.getElementById('status-text').innerText = "ğŸŒ¬ï¸ å¹æ°£ä¸­!";
                            document.getElementById('status-text').style.color = "#aaffaa";
                        } else {
                            isBlowing = false;
                            document.getElementById('status-text').innerText = "ğŸ˜ è«‹å˜Ÿå˜´ (Oå‹)";
                            document.getElementById('status-text').style.color = "white";
                        }
                    } else {
                        // æ²’åµæ¸¬åˆ°è‡‰
                        document.getElementById('status-text').innerText = "ğŸ‘€ æ‰¾ä¸åˆ°è‡‰ï¼Œè«‹é è¿‘é¡é ­";
                        document.getElementById('status-text').style.color = "yellow";
                    }
                });

                if (!window.Camera) throw new Error("Camera åº«æœªè¼‰å…¥");
                
                const cameraUtils = new window.Camera(videoElement, {
                    onFrame: async () => {
                        // ç›£æ¸¬å¹€æ•¸ï¼Œç¢ºä¿è¿´åœˆæœ‰åœ¨è·‘
                        frameCount++;
                        if (frameCount % 100 === 0) screenLog("å½±åƒè™•ç†ä¸­...", "#777");
                        
                        await faceMesh.send({image: videoElement});
                    },
                    width: 640,
                    height: 480
                });
                
                await cameraUtils.start();
                screenLog("ç›¸æ©Ÿè¿´åœˆå·²å•Ÿå‹•ï¼");

            } catch (err) {
                screenLog("ç›¸æ©Ÿå¤±æ•—: " + err.message, 'red');
                alert("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªç¶²å€ç‚º https é–‹é ­ã€‚");
                mode = 'mouse';
            }
        });
    </script>
</body>
</html>
