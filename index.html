<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>3D å¹æ³¡æ³¡ (ä¿®å¾©ç‰ˆ)</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            /* èƒŒæ™¯è‰²ï¼šé»ƒæ˜æ¼¸å±¤ */
            background: linear-gradient(180deg, #4b3d60 0%, #fd79a8 60%, #ffeaa7 100%);
            font-family: "Microsoft JhengHei", sans-serif;
        }
        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        .input_video { display: none; }

        /* ä»‹é¢å±¤ */
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 100;
            pointer-events: none; /* è®“é»æ“Šç©¿é€åˆ° 3D å±¤ */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        /* å•Ÿå‹•ç•«é¢ (åªæœ‰é€™å±¤æ¥æ”¶é»æ“Š) */
        #start-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 200;
            pointer-events: auto;
            color: white;
            text-align: center;
        }

        h1 { margin-bottom: 10px; font-size: 2rem; }
        p { color: #ccc; margin-bottom: 20px; max-width: 80%; line-height: 1.5; }
        
        .btn-group { display: flex; gap: 20px; }
        
        button {
            padding: 15px 25px;
            font-size: 1.1rem;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: 0.2s;
            font-weight: bold;
        }
        #btn-camera { background: #fd79a8; color: white; }
        #btn-mouse { background: #555; color: white; border: 1px solid #777; }
        
        button:hover { transform: scale(1.05); filter: brightness(1.1); }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        /* é™¤éŒ¯æ§åˆ¶å° (é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯ç”¨) */
        #debug-console {
            background: rgba(0, 0, 0, 0.6);
            color: #0f0;
            font-family: monospace;
            padding: 10px;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            text-align: left;
            pointer-events: auto;
            width: 100%;
            box-sizing: border-box;
        }
        
        /* ç‹€æ…‹æŒ‡ç¤ºç‡ˆ */
        #status-bar {
            text-align: center;
            padding: 20px;
            color: white;
            font-size: 1.2rem;
            text-shadow: 0 2px 5px rgba(0,0,0,0.5);
        }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1>ğŸŒ… 3D å¹æ³¡æ³¡</h1>
        <p>
            è«‹é¸æ“‡æ¨¡å¼ã€‚<br>
            è‹¥ç›¸æ©Ÿå¡ä½ï¼Œè«‹ç¢ºèªç¶²å€é–‹é ­æ˜¯ https:// <br>
            æˆ–å˜—è©¦ä½¿ç”¨æ»‘é¼ æ¨¡å¼ã€‚
        </p>
        <div class="btn-group">
            <button id="btn-camera">ğŸ“¸ é–‹å•Ÿç›¸æ©Ÿå¹æ°£</button>
            <button id="btn-mouse">ğŸ–±ï¸ æ»‘é¼ /è§¸æ§æ¨¡å¼ (æ¸¬è©¦ç”¨)</button>
        </div>
        <br>
        <p id="loading-msg" style="font-size: 0.9rem; color: #aaa;">ç³»çµ±æº–å‚™ä¸­...</p>
    </div>

    <div id="ui-layer">
        <div id="status-bar">ç­‰å¾…å•Ÿå‹•...</div>
        <div id="debug-console">--- ç³»çµ±æ—¥èªŒ ---<br></div>
    </div>

    <video class="input_video" playsinline></video>

    <script type="module">
        // ç‚ºäº†é¿å… import å¤±æ•—å°è‡´å…¨æ¯€ï¼Œä½¿ç”¨ try-catch åŒ…è¦†
        import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
        import { OrbitControls } from 'https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js';

        // --- æ—¥èªŒç³»çµ± ---
        const consoleDiv = document.getElementById('debug-console');
        function log(msg, isError = false) {
            const span = document.createElement('div');
            span.textContent = `> ${msg}`;
            if (isError) span.style.color = '#ff5555';
            consoleDiv.appendChild(span);
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            console.log(msg);
        }

        window.onerror = function(message, source, lineno, colno, error) {
            log(`éŒ¯èª¤: ${message}`, true);
        };

        log("ç¨‹å¼è…³æœ¬è¼‰å…¥æˆåŠŸ...");

        // --- è®Šæ•¸ ---
        let scene, camera, renderer, controls;
        let bubbles = [];
        let isBlowing = false;
        let blowDirection = 0;
        let mode = 'none'; // 'camera' or 'mouse'
        const mouse = new THREE.Vector2();
        const raycaster = new THREE.Raycaster();

        // --- UI å…ƒä»¶ ---
        const startScreen = document.getElementById('start-screen');
        const btnCamera = document.getElementById('btn-camera');
        const btnMouse = document.getElementById('btn-mouse');
        const statusBar = document.getElementById('status-bar');
        const videoElement = document.getElementsByClassName('input_video')[0];

        // --- 1. Three.js åˆå§‹åŒ– ---
        function initThree() {
            log("æ­£åœ¨åˆå§‹åŒ– 3D å ´æ™¯...");
            scene = new THREE.Scene();
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 25); // ç›¸æ©Ÿæ‹‰é 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.minDistance = 5;
            controls.maxDistance = 50;

            // ç‡ˆå…‰
            scene.add(new THREE.AmbientLight(0xffffff, 0.6));
            const dirLight = new THREE.DirectionalLight(0xffffff, 2);
            dirLight.position.set(10, 20, 10);
            scene.add(dirLight);

            // ç›£è½
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });
            window.addEventListener('pointerdown', onPointerDown);

            // æ¨¡æ“¬æ»‘é¼ å¹æ°£ (å¦‚æœæ²’æœ‰ç›¸æ©Ÿ)
            window.addEventListener('pointermove', (e) => {
                if (mode === 'mouse') {
                    // æ»‘é¼ æŒ‰ä½æ™‚å¹æ°£
                    if (e.buttons > 0) {
                        isBlowing = true;
                        blowDirection = (e.clientX / window.innerWidth - 0.5) * 5;
                        statusBar.innerText = "ğŸŒ¬ï¸ æ»‘é¼ æŒ‰ä½å¹æ°£ä¸­...";
                    } else {
                        isBlowing = false;
                        statusBar.innerText = "ğŸ‘† æŒ‰ä½æ»‘é¼ å·¦éµä¾†å¹æ°£";
                    }
                }
            });
            
            log("3D å ´æ™¯åˆå§‹åŒ–å®Œæˆ");
            animate();
        }

        // --- æ³¡æ³¡ç›¸é—œ ---
        const bubbleGeo = new THREE.SphereGeometry(1, 64, 64);
        const bubbleMat = new THREE.MeshPhysicalMaterial({
            color: 0xffffff,
            transmission: 1,
            opacity: 1,
            roughness: 0,
            thickness: 0.2,
            iridescence: 1,
            iridescenceIOR: 1.3,
            clearcoat: 1,
            side: THREE.DoubleSide
        });

        function createBubble() {
            const bubble = new THREE.Mesh(bubbleGeo, bubbleMat.clone());
            // å¾ä¸‹æ–¹ä¸­é–“ç”Ÿæˆ
            bubble.position.set((Math.random()-0.5)*2, -8, 5);
            const scale = 0.8 + Math.random();
            bubble.scale.set(scale, scale, scale);
            scene.add(bubble);

            // é€Ÿåº¦è¨ˆç®—
            const speedX = blowDirection * 0.3 + (Math.random()-0.5)*0.2;
            bubbles.push({
                mesh: bubble,
                velocity: new THREE.Vector3(speedX, 0.15 + Math.random()*0.1, -0.1)
            });
        }

        function onPointerDown(event) {
            // æˆ³ç ´é‚è¼¯
            mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            
            const sceneBubbles = bubbles.map(b => b.mesh);
            const intersects = raycaster.intersectObjects(sceneBubbles);
            if (intersects.length > 0) {
                const hit = intersects[0].object;
                scene.remove(hit);
                bubbles = bubbles.filter(b => b.mesh !== hit);
                // ç°¡å–®ç ´è£‚éŸ³æ•ˆæˆ–è¦–è¦ºå¯åŠ åœ¨æ­¤
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            controls.update();

            // ç”Ÿæˆæ³¡æ³¡
            if (isBlowing && Math.random() > 0.85) createBubble();

            // ç§»å‹•æ³¡æ³¡
            for (let i = bubbles.length - 1; i >= 0; i--) {
                const b = bubbles[i];
                b.mesh.position.add(b.velocity);
                b.mesh.position.y += Math.sin(Date.now()*0.001 + b.mesh.id)*0.01;
                
                if (b.mesh.position.y > 30) {
                    scene.remove(b.mesh);
                    bubbles.splice(i, 1);
                }
            }
            renderer.render(scene, camera);
        }

        // --- AI ç›¸æ©Ÿé‚è¼¯ ---
        let faceMesh;
        async function startCamera() {
            log("æ­£åœ¨å•Ÿå‹•ç›¸æ©Ÿ...");
            try {
                if (!faceMesh) {
                    log("æ­£åœ¨è¼‰å…¥ FaceMesh æ¨¡å‹ (è«‹ç¨å€™)...");
                    faceMesh = new FaceMesh({locateFile: (file) => {
                        return `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}`;
                    }});
                    faceMesh.setOptions({
                        maxNumFaces: 1,
                        refineLandmarks: true,
                        minDetectionConfidence: 0.5,
                        minTrackingConfidence: 0.5
                    });
                    faceMesh.onResults(onResults);
                }

                const cameraUtils = new Camera(videoElement, {
                    onFrame: async () => {
                        await faceMesh.send({image: videoElement});
                    },
                    width: 640,
                    height: 480
                });
                
                await cameraUtils.start();
                log("ç›¸æ©Ÿå•Ÿå‹•æˆåŠŸï¼è«‹å˜Ÿå˜´è©¦è©¦");
                startScreen.style.display = 'none';
                statusBar.innerText = "ğŸ˜ è«‹å˜Ÿèµ·å˜´å·´(Oå‹)å¹æ°£";
                mode = 'camera';

            } catch (err) {
                log("ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—: " + err.message, true);
                alert("ç›¸æ©Ÿç„¡æ³•å•Ÿå‹•ã€‚è«‹ç¢ºèªç¶²å€æ˜¯ https é–‹é ­ï¼Œæˆ–è€…æ”¹ç”¨æ»‘é¼ æ¨¡å¼ã€‚");
            }
        }

        function onResults(results) {
            if (results.multiFaceLandmarks && results.multiFaceLandmarks.length > 0) {
                const lm = results.multiFaceLandmarks[0];
                // ç°¡æ˜“å˜Ÿå˜´åˆ¤æ–· (ä¸Šä¸‹å”‡è·é›¢ / å·¦å³å˜´è§’è·é›¢)
                const mouthH = Math.hypot(lm[13].x - lm[14].x, lm[13].y - lm[14].y);
                const mouthW = Math.hypot(lm[61].x - lm[291].x, lm[61].y - lm[291].y);
                const ratio = mouthH / mouthW;

                // è‡‰éƒ¨æ–¹å‘
                const faceX = lm[1].x; // é¼»é ­
                blowDirection = (0.5 - faceX) * 8; // å¢å¼·éˆæ•åº¦

                if (ratio > 0.5 && mouthH > 0.01) { // é–¥å€¼å¯èª¿
                    isBlowing = true;
                    statusBar.innerText = "ğŸŒ¬ï¸ å¹æ°£ä¸­ï¼";
                    statusBar.style.color = "#afffba";
                } else {
                    isBlowing = false;
                    statusBar.innerText = "ğŸ˜ ç­‰å¾…å˜Ÿå˜´...";
                    statusBar.style.color = "white";
                }
            }
        }

        // --- æŒ‰éˆ•äº‹ä»¶ ---
        btnCamera.addEventListener('click', () => {
            initThree();
            startCamera();
        });

        btnMouse.addEventListener('click', () => {
            log("åˆ‡æ›è‡³æ»‘é¼ æ¨¡å¼");
            initThree();
            startScreen.style.display = 'none';
            mode = 'mouse';
            statusBar.innerText = "ğŸ‘† æŒ‰ä½æ»‘é¼ å·¦éµä¾†å¹æ°£ (æ¸¬è©¦æ¨¡å¼)";
        });

        log("ç³»çµ±å°±ç·’ï¼Œè«‹é»æ“ŠæŒ‰éˆ•");
    </script>
</body>
</html>
